<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recherche d'Événements - Voix du Nucléaire</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const Search = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const Calendar = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        );

        const ExternalLink = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
        );

        const Loader = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const MapPin = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const Building2 = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
        );

        const AlertCircle = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const EventFinder = () => {
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [region, setRegion] = useState('');
            const [error, setError] = useState('');
            const [sortBy, setSortBy] = useState('date');
            const [sortOrder, setSortOrder] = useState('asc');

            const searchEvents = async () => {
                if (!searchQuery.trim()) {
                    setError('Veuillez entrer un type d\'événement à rechercher');
                    return;
                }

                setLoading(true);
                setError('');
                setEvents([]);

                try {
                    const today = new Date();
                    const currentDate = today.toISOString().split('T')[0];

                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            model: 'claude-sonnet-4-20250514',
                            max_tokens: 4000,
                            messages: [
                                {
                                    role: 'user',
                                    content: `Recherche sur le web les événements FUTURS "${searchQuery}" dans les universités, écoles d'ingénieurs et IUTs${region ? ` en ${region}` : ' en France'} pour 2025-2026.

IMPORTANT : 
- La date d'aujourd'hui est ${currentDate}
- Ne retourne QUE les événements qui n'ont PAS encore eu lieu (date >= ${currentDate})
- Ignore tous les événements passés

Pour chaque événement trouvé, extrais :
- Nom de l'événement
- Nom de l'établissement
- Date au format YYYY-MM-DD (si disponible, sinon "Date à confirmer")
- Ville/Lieu
- URL complète de la page

Réponds UNIQUEMENT avec un tableau JSON dans ce format exact, sans autre texte :
[
  {
    "name": "nom événement",
    "institution": "nom établissement",
    "date": "YYYY-MM-DD ou 'Date à confirmer'",
    "location": "ville",
    "url": "URL complète"
  }
]

Si tu ne trouves aucun événement futur, retourne un tableau vide : []

Important : limite-toi aux 15 événements futurs les plus pertinents.`
                                }
                            ],
                            tools: [
                                {
                                    type: 'web_search_20250305',
                                    name: 'web_search'
                                }
                            ]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    let fullText = '';
                    if (data.content) {
                        for (const block of data.content) {
                            if (block.type === 'text') {
                                fullText += block.text + '\n';
                            }
                        }
                    }

                    let parsedEvents = [];
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'Erreur API');
                    }
                    
                    const cleanText = fullText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                    
                    if (!cleanText) {
                        setError('Aucune réponse reçue. Veuillez réessayer.');
                        setLoading(false);
                        return;
                    }
                    
                    try {
                        const jsonMatch = cleanText.match(/\[[\s\S]*\]/);
                        if (jsonMatch) {
                            parsedEvents = JSON.parse(jsonMatch[0]);
                        } else {
                            parsedEvents = JSON.parse(cleanText);
                        }
                        
                        if (!Array.isArray(parsedEvents)) {
                            throw new Error('Format de réponse invalide');
                        }
                        
                    } catch (parseError) {
                        console.error('Parse error:', parseError);
                        console.log('Raw response:', cleanText);
                        setError('Erreur lors de l\'analyse des résultats. La recherche a peut-être pris trop de temps. Essayez avec des critères plus spécifiques ou une région plus petite.');
                        setLoading(false);
                        return;
                    }

                    if (Array.isArray(parsedEvents) && parsedEvents.length > 0) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        const futureEvents = parsedEvents.filter(event => {
                            if (event.date === 'Date à confirmer' || !event.date) {
                                return true;
                            }
                            try {
                                const eventDate = new Date(event.date);
                                return eventDate >= today;
                            } catch {
                                return true;
                            }
                        });
                        
                        setEvents(futureEvents);
                        
                        if (futureEvents.length === 0) {
                            setError('Aucun événement futur trouvé. Tous les événements trouvés sont passés.');
                        }
                    } else {
                        setError('Aucun événement trouvé. Essayez avec des termes différents ou une autre région.');
                    }

                } catch (err) {
                    console.error('Search error:', err);
                    if (err.message.includes('API error')) {
                        setError('Erreur de connexion à l\'API. Veuillez vérifier votre connexion et réessayer.');
                    } else if (err.message.includes('timeout') || err.message.includes('trop de temps')) {
                        setError('La recherche a pris trop de temps. Essayez avec une région ou des critères plus spécifiques.');
                    } else {
                        setError('Une erreur est survenue lors de la recherche. Veuillez réessayer avec des critères différents.');
                    }
                } finally {
                    setLoading(false);
                }
            };

            const sortEvents = (eventsToSort) => {
                return [...eventsToSort].sort((a, b) => {
                    let compareA, compareB;
                    
                    switch (sortBy) {
                        case 'date':
                            if (a.date === 'Date à confirmer' && b.date !== 'Date à confirmer') return 1;
                            if (b.date === 'Date à confirmer' && a.date !== 'Date à confirmer') return -1;
                            if (a.date === 'Date à confirmer' && b.date === 'Date à confirmer') return 0;
                            
                            compareA = new Date(a.date);
                            compareB = new Date(b.date);
                            break;
                            
                        case 'name':
                            compareA = a.name.toLowerCase();
                            compareB = b.name.toLowerCase();
                            break;
                            
                        case 'institution':
                            compareA = a.institution.toLowerCase();
                            compareB = b.institution.toLowerCase();
                            break;
                            
                        case 'location':
                            compareA = a.location.toLowerCase();
                            compareB = b.location.toLowerCase();
                            break;
                            
                        default:
                            return 0;
                    }
                    
                    if (compareA < compareB) return sortOrder === 'asc' ? -1 : 1;
                    if (compareA > compareB) return sortOrder === 'asc' ? 1 : -1;
                    return 0;
                });
            };

            const handleSort = (column) => {
                if (sortBy === column) {
                    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortBy(column);
                    setSortOrder('asc');
                }
            };

            const sortedEvents = sortEvents(events);

            const SortIcon = ({ column }) => {
                if (sortBy !== column) return null;
                return (
                    <span className="ml-1">
                        {sortOrder === 'asc' ? '↑' : '↓'}
                    </span>
                );
            };

            const regions = [
                '',
                'Auvergne-Rhône-Alpes',
                'Bourgogne-Franche-Comté',
                'Bretagne',
                'Centre-Val de Loire',
                'Corse',
                'Grand Est',
                'Hauts-de-France',
                'Île-de-France',
                'Normandie',
                'Nouvelle-Aquitaine',
                'Occitanie',
                'Pays de la Loire',
                'Provence-Alpes-Côte d\'Azur'
            ];

            const eventTypes = [
                'forum des métiers',
                'journée orientation',
                'portes ouvertes',
                'salon étudiant',
                'forum entreprises'
            ];

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="mb-6">
                                <h1 className="text-3xl font-bold text-indigo-900 flex items-center gap-2">
                                    <Search className="w-8 h-8" />
                                    Recherche d'Événements Universitaires
                                </h1>
                                <p className="text-gray-600 mt-1">
                                    Voix du Nucléaire - Trouvez automatiquement les événements dans les universités et écoles
                                </p>
                            </div>

                            <div className="space-y-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Type d'événement
                                    </label>
                                    <div className="flex gap-2 flex-wrap mb-2">
                                        {eventTypes.map(type => (
                                            <button
                                                key={type}
                                                onClick={() => setSearchQuery(type)}
                                                className={`px-4 py-2 rounded-lg transition ${
                                                    searchQuery === type
                                                        ? 'bg-indigo-600 text-white'
                                                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                                }`}
                                            >
                                                {type}
                                            </button>
                                        ))}
                                    </div>
                                    <input
                                        type="text"
                                        placeholder="ou tapez votre propre recherche..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && searchEvents()}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Région (optionnel)
                                    </label>
                                    <select
                                        value={region}
                                        onChange={(e) => setRegion(e.target.value)}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                    >
                                        <option value="">Toute la France</option>
                                        {regions.slice(1).map(r => (
                                            <option key={r} value={r}>{r}</option>
                                        ))}
                                    </select>
                                </div>

                                <button
                                    onClick={searchEvents}
                                    disabled={loading}
                                    className="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 flex items-center justify-center gap-2 transition font-medium"
                                >
                                    {loading ? (
                                        <>
                                            <Loader className="w-5 h-5 animate-spin" />
                                            Recherche en cours...
                                        </>
                                    ) : (
                                        <>
                                            <Search className="w-5 h-5" />
                                            Rechercher les événements
                                        </>
                                    )}
                                </button>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 flex items-start gap-3">
                                    <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                                    <p className="text-red-800">{error}</p>
                                </div>
                            )}
                        </div>

                        {events.length > 0 && (
                            <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-indigo-600 text-white">
                                            <tr>
                                                <th 
                                                    onClick={() => handleSort('date')}
                                                    className="px-6 py-4 text-left font-semibold cursor-pointer hover:bg-indigo-700 transition"
                                                >
                                                    Date <SortIcon column="date" />
                                                </th>
                                                <th 
                                                    onClick={() => handleSort('name')}
                                                    className="px-6 py-4 text-left font-semibold cursor-pointer hover:bg-indigo-700 transition"
                                                >
                                                    Événement <SortIcon column="name" />
                                                </th>
                                                <th 
                                                    onClick={() => handleSort('institution')}
                                                    className="px-6 py-4 text-left font-semibold cursor-pointer hover:bg-indigo-700 transition"
                                                >
                                                    Établissement <SortIcon column="institution" />
                                                </th>
                                                <th 
                                                    onClick={() => handleSort('location')}
                                                    className="px-6 py-4 text-left font-semibold cursor-pointer hover:bg-indigo-700 transition"
                                                >
                                                    Lieu <SortIcon column="location" />
                                                </th>
                                                <th className="px-6 py-4 text-left font-semibold">Lien</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-200">
                                            {sortedEvents.map((event, index) => {
                                                let displayDate = event.date;
                                                if (event.date && event.date !== 'Date à confirmer') {
                                                    try {
                                                        const dateObj = new Date(event.date);
                                                        displayDate = dateObj.toLocaleDateString('fr-FR', { 
                                                            day: 'numeric', 
                                                            month: 'long', 
                                                            year: 'numeric' 
                                                        });
                                                    } catch {
                                                        displayDate = event.date;
                                                    }
                                                }
                                                
                                                return (
                                                    <tr key={index} className="hover:bg-gray-50 transition">
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center gap-2 text-gray-900">
                                                                <Calendar className="w-4 h-4 text-indigo-600" />
                                                                <span className="font-medium">{displayDate}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="font-medium text-gray-900">{event.name}</div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center gap-2 text-gray-700">
                                                                <Building2 className="w-4 h-4 text-gray-400" />
                                                                <span>{event.institution}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            <div className="flex items-center gap-2 text-gray-700">
                                                                <MapPin className="w-4 h-4 text-gray-400" />
                                                                <span>{event.location}</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-6 py-4">
                                                            {event.url && (
                                                                <a
                                                                    href={event.url}
                                                                    target="_blank"
                                                                    rel="noopener noreferrer"
                                                                    className="inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-800 font-medium"
                                                                >
                                                                    Voir
                                                                    <ExternalLink className="w-4 h-4" />
                                                                </a>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="bg-gray-50 px-6 py-4 border-t border-gray-200">
                                    <p className="text-gray-600 text-sm">
                                        {events.length} événement{events.length > 1 ? 's' : ''} futur{events.length > 1 ? 's' : ''} trouvé{events.length > 1 ? 's' : ''}
                                    </p>
                                </div>
                            </div>
                        )}

                        {!loading && events.length === 0 && !error && (
                            <div className="bg-white rounded-lg shadow-lg p-12 text-center">
                                <Search className="w-16 h-16 mx-auto mb-4 text-gray-300" />
                                <h3 className="text-xl font-semibold text-gray-700 mb-2">
                                    Prêt à rechercher
                                </h3>
                                <p className="text-gray-500">
                                    Sélectionnez un type d'événement et lancez la recherche pour trouver des opportunités
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<EventFinder />, document.getElementById('root'));
    </script>
</body>
</html>